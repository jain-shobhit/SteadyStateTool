function [Kb]=Allman_bending_stiffness(nodes,E,nu,t)
%
% Ref: D.J. Allman "A Simple Cubic Displacement element for plate bending", 
% Int. J. Num. Meth. Eng., vol. 10, 263-281, 1976


co1=nodes(1,:);
co2=nodes(2,:);
co3=nodes(3,:);

x1=co1(1); y1=co1(2);
x2=co2(1); y2=co2(2);
x3=co3(1); y3=co3(2);

co=[1  1  1;
    x1 x2 x3;
    y1 y2 y3];
    
A=1/2*det(co);

x=[x1 x2 x3];
y=[y1 y2 y3];

x12=x1-x2;  y21=y2-y1;
x23=x2-x3;  y32=y3-y2;
x31=x3-x1;  y13=y1-y3;

D=E*t^3/(12*(1-nu^2));

L12=sqrt(x12^2+y21^2);
L23=sqrt(x23^2+y32^2);
L31=sqrt(x31^2+y13^2);

% g12=atan2(y21,-x12);
% if g12<0
%     g12=g12+2*pi;
% end
% 
% g23=atan2(y32,-x23);
% if g23<0
%     g23=g23+2*pi;
% end
% 
% g31=atan2(y13,-x31);
% if g31<0
%     g31=g31+2*pi;
% end
% 
% g12=g12-pi/2;
% g23=g23-pi/2;
% g31=g31-pi/2;
% 
% g=[g12 g23 g31]

% sin12=sin(g12); cos12=cos(g12);
% sin23=sin(g23); cos23=cos(g23);
% sin31=sin(g31); cos31=cos(g31);

sin12=x12/L12; cos12=y21/L12;
sin23=x23/L23; cos23=y32/L23;
sin31=x31/L31; cos31=y13/L31;

si=[sin12 sin23 sin31];
co=[cos12 cos23 cos31];

H(1,:)=[                                     2;
                                             0;
                                          2*nu;
                                2*x1+2*x2+2*x3;
                          2/3*y1+2/3*y2+2/3*y3;
         2/3*nu*(x2-x3)+2/3*nu*(x1-x3)+2*nu*x3;
             2*nu*(y2-y3)+2*nu*(y1-y3)+6*nu*y3]';

H(2,:)=[                                                         0;
                                                              1-nu;
                                                                 0;
                                                                 0;
         1/6*(4-4*nu)*(x2-x3)+1/6*(4-4*nu)*(x1-x3)+1/2*(4-4*nu)*x3;
         1/6*(4-4*nu)*(y2-y3)+1/6*(4-4*nu)*(y1-y3)+1/2*(4-4*nu)*y3;
                                                                 0]';

H(3,:)=[                                     0;
                                             0;
                                             2;
             2*nu*(x2-x3)+2*nu*(x1-x3)+6*nu*x3;
         2/3*nu*(y2-y3)+2/3*nu*(y1-y3)+2*nu*y3;
                          2/3*x1+2/3*x2+2/3*x3;
                                2*y1+2*y2+2*y3]';
                            

                            
H(4,:)=[                                                                                                                                                                               0;
                                                                                                                                                                                       0;
                                                                                                                                                                                       0;
                                                                                                           3*(x2-x3)^2+3*(x1-x3)*(x2-x3)+3*(x1-x3)^2+12*x3*(x2-x3)+12*x3*(x1-x3)+18*x3^2;
 1/12*(12*x2-12*x3)*(y2-y3)+1/24*(12*x1-12*x3)*(y2-y3)+1/24*(12*x2-12*x3)*(y1-y3)+1/12*(12*x1-12*x3)*(y1-y3)+2*x3*(y2-y3)+1/6*(12*x2-12*x3)*y3+2*x3*(y1-y3)+1/6*(12*x1-12*x3)*y3+6*x3*y3;
                                                                                                  nu*(x2-x3)^2+nu*(x1-x3)*(x2-x3)+nu*(x1-x3)^2+4*nu*x3*(x2-x3)+4*nu*x3*(x1-x3)+6*nu*x3^2;
                     3*nu*(x2-x3)*(y2-y3)+3/2*nu*(x1-x3)*(y2-y3)+3/2*nu*(x2-x3)*(y1-y3)+3*nu*(x1-x3)*(y1-y3)+6*nu*x3*(y2-y3)+6*nu*(x2-x3)*y3+6*nu*x3*(y1-y3)+6*nu*(x1-x3)*y3+18*nu*x3*y3]';
                 
H(5,:)=[                                                                                                                                                                                                                                  0;
                                                                                                                                                                                                                                          0;
                                                                                                                                                                                                                                          0;
                                                                                                                                                                                                                                          0;
       1/3*(8-8*nu)*x3*(x2-x3)+1/12*(8-8*nu)*(x1-x3)*(x2-x3)+1/3*(y2-y3)^2+1/12*(8-8*nu)*(x2-x3)^2+1/3*(8-8*nu)*x3*(x1-x3)+4/3*y3*(y2-y3)+1/3*(y1-y3)*(y2-y3)+2*y3^2+4/3*y3*(y1-y3)+1/3*(y1-y3)^2+1/2*(8-8*nu)*x3^2+1/12*(8-8*nu)*(x1-x3)^2;
 1/12*(8-4*nu)*(x2-x3)*(y2-y3)+1/24*(8-4*nu)*(x1-x3)*(y2-y3)+1/24*(8-4*nu)*(x2-x3)*(y1-y3)+1/12*(8-4*nu)*(x1-x3)*(y1-y3)+1/6*(8-4*nu)*x3*(y2-y3)+1/6*(8-4*nu)*(x2-x3)*y3+1/6*(8-4*nu)*x3*(y1-y3)+1/6*(8-4*nu)*(x1-x3)*y3+1/2*(8-4*nu)*x3*y3;
                                                                                                                                                     nu*(y2-y3)^2+nu*(y1-y3)*(y2-y3)+nu*(y1-y3)^2+4*nu*y3*(y2-y3)+4*nu*y3*(y1-y3)+6*nu*y3^2]';
                                                                                                                                                 

                                                                                                                                                 
H(6,:)=[                                                                                                                                                                                                                            0;
                                                                                                                                                                                                                                    0;
                                                                                                                                                                                                                                    0;
                                                                                                                                                                                                                                    0;
                                                                                                                                                                                                                                    0;
 1/12*(8-8*nu)*(y2-y3)^2+1/3*(8-8*nu)*y3*(y1-y3)+1/12*(8-8*nu)*(y1-y3)*(y2-y3)+1/2*(8-8*nu)*y3^2+1/12*(8-8*nu)*(y1-y3)^2+2*x3^2+4/3*x3*(x1-x3)+1/3*(8-8*nu)*y3*(y2-y3)+1/3*(x1-x3)^2+4/3*x3*(x2-x3)+1/3*(x1-x3)*(x2-x3)+1/3*(x2-x3)^2;
                                              1/12*(12*x2-12*x3)*(y2-y3)+1/24*(12*x1-12*x3)*(y2-y3)+1/24*(12*x2-12*x3)*(y1-y3)+1/12*(12*x1-12*x3)*(y1-y3)+2*x3*(y2-y3)+1/6*(12*x2-12*x3)*y3+2*x3*(y1-y3)+1/6*(12*x1-12*x3)*y3+6*x3*y3]';

H(7,:)=[                                                                     0;
                                                                             0;
                                                                             0;
                                                                             0;
                                                                             0;
                                                                             0;
 3*(y2-y3)^2+3*(y1-y3)*(y2-y3)+3*(y1-y3)^2+12*y3*(y2-y3)+12*y3*(y1-y3)+18*y3^2]';          

%H
%H'
%H+tril(H',2)
H=2*A*D*(H'+H-diag(diag(H)));
%H=2*A*D*(H+tril(H',1))
T=zeros(12,9);

T(1,1)=1;
T(2,4)=1;
T(3,7)=1;

T(4,1:6)=[L12/2 -L12^2/12*sin12 L12^2/12*cos12 L12/2 L12^2/12*sin12 -L12^2/12*cos12];
T(5,4:end)=[L23/2 -L23^2/12*sin23 L23^2/12*cos23 L23/2 L23^2/12*sin23 -L23^2/12*cos23];
T(6,[1:3 7:9])=[L31/2 L31^2/12*sin31 -L31^2/12*cos31 L31/2 -L31^2/12*sin31 L31^2/12*cos31];

T(7,[2:3 5:6])=[-L12/3*cos12 -L12/3*sin12 -L12/6*cos12 -L12/6*sin12];
T(8,[2:3 5:6])=[-L12/6*cos12 -L12/6*sin12 -L12/3*cos12 -L12/3*sin12];

T(9,[5:6 8:9])=[-L23/3*cos23 -L23/3*sin23 -L23/6*cos23 -L23/6*sin23];
T(10,[5:6 8:9])=[-L23/6*cos23 -L23/6*sin23 -L23/3*cos23 -L23/3*sin23];

T(11,[2:3 8:9])=[-L31/6*cos31 -L31/6*sin31 -L31/3*cos31 -L31/3*sin31];
T(12,[2:3 8:9])=[-L31/3*cos31 -L31/3*sin31 -L31/6*cos31 -L31/6*sin31];

%S1=sin(2*g12)-sin(2*g31);
S1=2*sin12*cos12-2*sin31*cos31;
%S2=sin(2*g23)-sin(2*g12);
S2=2*sin23*cos23-2*sin12*cos12;
%S3=sin(2*g31)-sin(2*g23);
S3=2*sin31*cos31-2*sin23*cos23;
%C1=cos(2*g12)-cos(2*g31);
C1=cos12^2-sin12^2-(cos31^2-sin31^2);
%C2=cos(2*g23)-cos(2*g12);
C2=cos23^2-sin23^2-(cos12^2-sin12^2);
%C3=cos(2*g31)-cos(2*g23);
C3=cos31^2-sin31^2-(cos23^2-sin23^2);

S=[S1 S2 S3];
C=[C1 C2 C3];

B=zeros(7,12);

for i=1:3
    B(1,i)=D*(1-nu)*S(i);
    B(2,i)=-D*(1-nu)*C(i);
    B(3,i)=-B(1,i);
    B(4,i)=3*x(i)*D*(1-nu)*S(i);
    B(5,i)=-D*(1-nu)*(-y(i)*S(i)+2*x(i)*C(i));
    B(6,i)=-D*(1-nu)*(x(i)*S(i)+2*y(i)*C(i));
    B(7,i)=-3*y(i)*D*(1-nu)*S(i);
end

for i=4:6
    j=i-3;
    B(1,i)=0;
    B(2,i)=0;
    B(3,i)=0;
    B(4,i)=-6*D*co(j)*(1+(1-nu)*si(j)^2);
    B(5,i)=-2*D*si(j)*((2-nu)*si(j)^2+(2*nu-1)*co(j)^2);
    B(6,i)=-2*D*co(j)*((2-nu)*co(j)^2+(2*nu-1)*si(j)^2);
    B(7,i)=-6*D*si(j)*(1+(1-nu)*co(j)^2);
end

for i=7:2:11
    j=1/2*(i-5);
    B(1,i)=-2*D*(co(j)^2+nu*si(j)^2);
    B(2,i)=-D*(1-nu)*2*si(j)*co(j);
    B(3,i)=-2*D*(nu*co(j)^2+si(j)^2);
    B(4,i)=-6*x(j)*D*(co(j)^2+nu*si(j)^2);
    B(5,i)=-2*D*(y(j)*(co(j)^2+nu*si(j)^2)+x(j)*(1-nu)*2*si(j)*co(j));
    B(6,i)=-2*D*(x(j)*(nu*co(j)^2+si(j)^2)+y(j)*(1-nu)*2*si(j)*co(j));
    B(7,i)=-6*y(j)*D*(nu*co(j)^2+si(j)^2);
end

for i=8:2:12
    j=1/2*(i-6);
    if (j==1||j==2)
        k=j+1;
	else
        k=1;
	end
    
    B(1,i)=-2*D*(co(j)^2+nu*si(j)^2);
    B(2,i)=-D*(1-nu)*2*si(j)*co(j); %sin(2*g(j));
    B(3,i)=-2*D*(nu*co(j)^2+si(j)^2);
    B(4,i)=-6*x(k)*D*(co(j)^2+nu*si(j)^2);
    B(5,i)=-2*D*(y(k)*(co(j)^2+nu*si(j)^2)+x(k)*(1-nu)*2*si(j)*co(j)); %sin(2*g(j)));
    B(6,i)=-2*D*(x(k)*(nu*co(j)^2+si(j)^2)+y(k)*(1-nu)*2*si(j)*co(j)); %sin(2*g(j)));
    B(7,i)=-6*y(k)*D*(nu*co(j)^2+si(j)^2);
end

 
Kb=(B*T)'*(H\(B*T));

Kb([2 3 5 6 8 9],:)=Kb([3 2 6 5 9 8],:);
Kb(:,[2 3 5 6 8 9])=Kb(:,[3 2 6 5 9 8]);

Kb([3 6 9],:)=-Kb([3 6 9],:);
Kb(:,[3 6 9])=-Kb(:,[3 6 9]);

Kb=1/2*(Kb'+Kb);

% ----- Generalized load vector for linearly varying pressure...

% G=[x1^2 x1*y1 y1^2 x1^3 x1^2*y1 x1*y1^2 y1^3;
%    x2^2 x2*y2 y2^2 x2^3 x2^2*y2 x2*y2^2 y2^3;
%    x3^2 x3*y3 y3^2 x3^3 x3^2*y3 x3*y3^2 y3^3];
% 
% C0=1/(2*A)*[2*A/3 0 0 2*A/3 0 0 2*A/3 0 0;
%             y2-y3 0 0 y3-y1 0 0 y1-y2 0 0;
%             x3-x2 0 0 x1-x3 0 0 x2-x1 0 0];
% 
% C1=C0([1 2 3],[1 4 7])
% 
% N0=2*A*[1/2 1/6  1/6;
%         1/6 1/12 1/24;
%         1/6 1/24 1/12];
% 
% N1=2*A*[1/12  1/20  1/60;
%         1/24  1/60  1/60;
%         1/12  1/60  1/20;
%         1/20  1/30  1/120;
%         1/60  1/120 1/180;
%         1/60  1/180 1/120;
%         1/20  1/120 1/30];
% 
% S1=C0'*N0*C1;
% S2=N1*C1-G'*(C1'*N0*C1);
% 
% load=(S1+(B*T)'*inv(H)*S2)*[1 1 1]' 

